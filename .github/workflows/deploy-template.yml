name: Deploy Template

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
    secrets:
      ANSIBLE_VAULT_PASSWORD:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
      ANSIBLE_PYTHON: /opt/pipx/venvs/ansible-core/bin/python
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -qr render_data/requirements.txt
      - name: Show environment name
        run: echo "Environment: ${{ inputs.environment }}"
      - name: Run render_data/tasks.py
        run: |
          cd render_data
          invoke convert-blogs-markdown-to-html
          invoke convert-projects-markdown-to-html
      - name: Install Ansible Python requirements
        run: |
          $ANSIBLE_PYTHON -m pip install -qr aws/bin/requirements.txt
      - name: Create Ansible Vault password file
        env:
          ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
        run: |
          echo "$ANSIBLE_VAULT_PASSWORD" > .vault_pass
          chmod 600 .vault_pass
      - name: Deploy base infrastructure
        run: env=${{ env.ENV }} aws/bin/deploy-base-infrastructure --vault-password-file .vault_pass
      - name: Deploy frontend
        run: env=${{ env.ENV }} aws/bin/deploy-frontend --vault-password-file .vault_pass
      - name: Build and upload frontend
        run: env=${{ env.ENV }} aws/bin/build-n-upload-frontend --vault-password-file .vault_pass
      - name: Deploy backend view counter
        run: env=${{ env.ENV }} aws/bin/deploy-backend-view-counter --vault-password-file .vault_pass
      - name: Ensure shred is installed
        if: always()
        run: |
          if ! command -v shred >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y coreutils
          fi
      - name: Remove Ansible Vault password file
        if: always()
        run: shred -u .vault_pass || rm -f .vault_pass
