#! /usr/bin/env bash
env=${env:-dev}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RESULTS_FILE=/tmp/result.json
ansible-playbook "$SCRIPT_DIR/../playbook/deploy.yml" -e env=$env --ask-vault-pass > $RESULTS_FILE

# Extract and rewrite as JSON
cloudfront_id=$(awk -F'"' '/CloudFrontDistributionId/ {print $4}' $RESULTS_FILE)
echo "{\"cloudfront_distribution_id\": \"$cloudfront_id\"}" > /tmp/cloudfront_output.json
echo "cloudfront_distribution_id: $cloudfront_id" > /tmp/cloudfront_output.yml