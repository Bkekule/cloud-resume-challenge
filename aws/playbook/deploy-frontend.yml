---
- name: Deploy CloudFormation Stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    env: dev
    template_path: "{{ [playbook_dir, '..', 'frontend.yml'] | path_join }}"

  pre_tasks:
    - name: Validate environment selection
      ansible.builtin.assert:
        that:
          - env in ['dev', 'qa', 'prod']
        fail_msg: "Invalid env '{{ env }}'. Use dev, qa, or prod."

    - name: Load shared environment vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'common', 'env.yml'] | path_join }}"

    - name: Load frontend environment vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'frontend', 'env.yml'] | path_join }}"

    - name: Load vault vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'vault.yml'] | path_join }}"

    - name: Assert required vars exist
      ansible.builtin.assert:
        that:
          - frontend_stack_name is defined
          - region is defined
          - bucket_name is defined
          - aws_access_key_id is defined
          - aws_secret_access_key is defined
          - custom_domain_name is defined
          - base_infrastructure_stack_name is defined
        fail_msg: "Missing required env vars: 'frontend_stack_name', 'bucket_name', 'region', 'custom_domain_name', 'base_infrastructure_stack_name', and/or AWS credentials."

    - name: Get base infrastructure stack outputs
      amazon.aws.cloudformation_info:
        stack_name: "{{ base_infrastructure_stack_name }}"
        region: "{{ region }}"
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
      register: base_stack_info

    - name: Set hosted_zone_id from base stack
      ansible.builtin.set_fact:
        hosted_zone_id: "{{ base_stack_info.cloudformation[base_infrastructure_stack_name].stack_outputs.HostedZoneId }}"

  tasks:
    - name: Deploy CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ frontend_stack_name }}"
        state: present
        region: "{{ region }}"
        template: "{{ template_path }}"
        template_parameters:
          BucketName: "{{ bucket_name }}"
          CustomDomain: "{{ custom_domain_name }}"
          HostedZoneId: "{{ hosted_zone_id }}"
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
      register: cf_output

    - name: Display stack outputs
      ansible.builtin.debug:
        var: cf_output
