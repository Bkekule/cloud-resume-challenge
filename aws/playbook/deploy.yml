---
- name: Deploy CloudFormation Stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    env: dev
    template_path: "{{ playbook_dir | path_join('..', 'template.yml') }}"

  pre_tasks:
    - name: Validate environment selection
      ansible.builtin.assert:
        that:
          - env in ['dev', 'prod']
        fail_msg: "Invalid env '{{ env }}'. Use dev, qa, or prod."

    - name: Load environment vars
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/environments/{{ env }}/env.yml"

    - name: Load vault vars
      ansible.builtin.include_vars:
        file: "{{ playbook_dir }}/environments/{{ env }}/vault.yml"

    - name: Assert required vars exist
      ansible.builtin.assert:
        that:
          - stack_name is defined
          - region is defined
        fail_msg: "Missing required env vars: 'stack_name' and/or 'region'"

  tasks:
    - name: Deploy CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        state: present
        region: "{{ region }}"
        template: "{{ template_path }}"
      environment:
        AWS_ACCESS_KEY_ID: "{{ aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ aws_secret_access_key }}"
        AWS_SESSION_TOKEN: "{{ aws_session_token | default(omit) }}"
      register: cf_output

    - name: Display stack outputs
      ansible.builtin.debug:
        var: cf_output
