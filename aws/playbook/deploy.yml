---
- name: Deploy CloudFormation Stack
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    env: dev
    template_path: "{{ [playbook_dir, '..', 'template.yml'] | path_join }}"

  pre_tasks:
    - name: Validate environment selection
      ansible.builtin.assert:
        that:
          - env in ['dev', 'qa', 'prod']
        fail_msg: "Invalid env '{{ env }}'. Use dev, qa, or prod."

    - name: Load environment vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'env.yml'] | path_join }}"

    - name: Load vault vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'vault.yml'] | path_join }}"

    - name: Assert required vars exist
      ansible.builtin.assert:
        that:
          - stack_name is defined
          - region is defined
          - bucket_name is defined
        fail_msg: "Missing required env vars: 'stack_name' 'bucket_name', and/or 'region'"

  tasks:
    - name: Deploy CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ stack_name }}"
        state: present
        region: "{{ region }}"
        template: "{{ template_path }}"
        template_parameters:
          BucketName: "{{ bucket_name }}"
          CustomDomain: "{{ custom_domain }}"
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
      register: cf_output

    - name: Display stack outputs
      ansible.builtin.debug:
        var: cf_output
