---
- name: Deploy Base Infrastructure (Route53 Hosted Zone)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    template_path: "{{ [playbook_dir, '..', 'base-infrastructure.yml'] | path_join }}"

  pre_tasks:
    - name: Validate environment selection
      ansible.builtin.assert:
        that:
          - env in ['qa', 'prod']
        fail_msg: "Invalid env '{{ env }}'. Use qa or prod."

    - name: Load shared environment vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'common', 'env.yml'] | path_join }}"

    - name: Load vault vars
      ansible.builtin.include_vars:
        file: "{{ [playbook_dir, 'environment', 'vault.yml'] | path_join }}"

    - name: Assert required vars exist
      ansible.builtin.assert:
        that:
          - base_infrastructure_stack_name is defined
          - domain_name is defined
          - region is defined
          - aws_access_key_id is defined
          - aws_secret_access_key is defined
        fail_msg: "Missing required env vars: 'base_infrastructure_stack_name', 'domain_name', 'region', and/or AWS credentials."

  tasks:
    - name: Deploy CloudFormation stack
      amazon.aws.cloudformation:
        stack_name: "{{ base_infrastructure_stack_name }}"
        state: present
        region: "{{ region }}"
        template: "{{ template_path }}"
        template_parameters:
          DomainName: "{{ domain_name }}"
        aws_access_key_id: "{{ aws_access_key_id }}"
        aws_secret_access_key: "{{ aws_secret_access_key }}"
      register: cf_output

    - name: Display stack outputs
      ansible.builtin.debug:
        var: cf_output
